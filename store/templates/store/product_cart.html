{% extends 'store/base.html' %}
{% block title %}Your Cart{% endblock %}
{% block content %}
<h2 class="mb-4">Your Shopping Cart</h2>
{% if cart_items %}
<table class="table table-bordered align-middle">
  <thead class="table-primary">
    <tr>
      <th>Image</th><th>Product</th><th class="text-center">Qty</th><th class="text-end">Subtotal</th><th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for item in cart_items %}
    <tr id="row-{{ item.product.id }}">
      <td><img src="{{ item.product.image.url }}" width="60"></td>
      <td>
        <strong>{{ item.product.name }}</strong><br>
        <small class="text-muted">üöö by {{ item.product.estimated_delivery_date|date:"d M Y" }}</small>
      </td>
      <td class="text-center">
        <button class="btn btn-outline-secondary btn-sm update-cart" data-id="{{ item.product.id }}" data-action="decrease" {% if item.qty==1 %}disabled{% endif %}>‚àí</button>
        <span class="mx-1" id="qty-{{ item.product.id }}">{{ item.qty }}</span>
        <button class="btn btn-outline-secondary btn-sm update-cart" data-id="{{ item.product.id }}" data-action="increase">+</button>
      </td>
      <td class="text-end" id="sub-{{ item.product.id }}">‚Çπ{{ item.subtotal }}</td>
      <td class="text-center">
        <a href="{% url 'store:remove-from-cart' item.product.id %}" class="btn btn-danger btn-sm">Remove</a>
      </td>
    </tr>
    {% endfor %}
    <tr>
      <td colspan="3" class="text-end"><strong>Total:</strong></td>
      <td class="text-end" id="cart-total">‚Çπ{{ total }}</td>
      <td></td>
    </tr>
    <tr>
      <td colspan="5" class="text-end text-success">
        <strong>Expected Delivery:</strong> {{ latest_delivery|date:"d M Y" }}
      </td>
    </tr>
  </tbody>
</table>
<div class="d-flex justify-content-between">
  <a class="btn btn-outline-secondary" href="{% url 'store:product-list' %}">‚Üê Continue Shopping</a>
  <a class="btn btn-success" href="{% url 'store:checkout' %}">Proceed to Checkout ‚Üí</a>
</div>

<script>
document.querySelectorAll('.update-cart').forEach(btn=>{
  btn.onclick = ()=>{
    fetch("{% url 'store:ajax-update-cart' %}", {
      method:'POST',
      headers:{ 'X-CSRFToken':window.CSRF_TOKEN,'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded' },
      body:`product_id=${btn.dataset.id}&action=${btn.dataset.action}`
    }).then(r=>r.json()).then(d=>{
      if (d.success){
        document.getElementById('qty-'+btn.dataset.id).textContent = d.quantity;
        document.getElementById('sub-'+btn.dataset.id).textContent = '‚Çπ'+d.subtotal;
        document.getElementById('cart-total').textContent = '‚Çπ'+d.cartTotal;
        document.getElementById('cart-count').textContent = d.cartCount;
      }
    });
  };
});
</script>

{% else %}
<div class="alert alert-info">Your cart is empty. <a href="{% url 'store:product-list' %}">Start shopping</a>.</div>
{% endif %}
{% endblock %}